name: CI

on:
  push:
  pull_request:

permissions:
  contents: write  # needed for auto-commit of formatting and pushing changes

jobs:
  clean:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install formatters
        run: |
          python -m pip install --upgrade pip
          pip install black isort

      - name: Run Black
        run: black .

      - name: Run isort (profile=black)
        run: isort --profile black .

      - name: Auto-commit formatting changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: auto-format with black + isort"
          commit_user_name: romainsacchi
          commit_user_email: r_s@me.com
          push_options: --force-with-lease
          skip_fetch: true

  build:
    runs-on: ubuntu-latest
    needs: clean
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
          pip install pytest pytest-cov coveralls

      - name: Run tests (skip failure if none collected) and create coverage
        id: pytest
        run: |
          set -e
          # Run pytest and capture exit code; 5 == no tests collected
          pytest -m "not ecoinvent" -s --cov=brightpath || echo "PYTEST_EXIT_CODE=$?" >> $GITHUB_OUTPUT
          # Determine if no tests were collected
          EXIT_CODE="${PYTEST_EXIT_CODE:-0}"
          if [ "$EXIT_CODE" = "5" ]; then
            echo "no_tests=true" >> $GITHUB_OUTPUT
            echo "No tests collected; skipping coverage upload."
          elif [ "$EXIT_CODE" != "0" ]; then
            echo "Pytest failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          else
            echo "no_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload coverage to Coveralls
        if: steps.pytest.outputs.no_tests == 'false'
        run: coveralls --verbose --service=github
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COVERALLS_REPO_TOKEN: $
